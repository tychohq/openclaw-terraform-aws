# PRD: Pre-Configured OpenClaw AWS Terraform Deployment

## Goal
Extend this existing Terraform project (forked from janobarnard/openclaw-aws) so that the instance boots up FULLY CONFIGURED â€” no manual `openclaw onboard` step needed. Users pass in their keys, channel tokens, skills list, and seed workspace files via Terraform variables, and cloud-init does the rest.

## Current State
- `terraform/` has: main.tf, ec2.tf, variables.tf, vpc.tf, security.tf, iam.tf, outputs.tf
- `setup.sh` is an interactive wizard
- cloud-init in ec2.tf installs Node.js, creates openclaw user, installs openclaw globally, creates a systemd service, but does NOT configure openclaw (requires manual `openclaw onboard`)

## What to Build

### 1. New Terraform Variables (in variables.tf)

Add these optional variables (all with `default = ""` or `default = []` so existing behavior is preserved):

```hcl
# LLM Provider Keys
variable "anthropic_api_key" { type = string; default = ""; sensitive = true }
variable "openai_api_key" { type = string; default = ""; sensitive = true }
variable "google_api_key" { type = string; default = ""; sensitive = true }

# Channel Tokens  
variable "discord_bot_token" { type = string; default = ""; sensitive = true }
variable "discord_guild_id" { type = string; default = "" }
variable "telegram_bot_token" { type = string; default = ""; sensitive = true }
variable "telegram_owner_id" { type = string; default = "" }
variable "whatsapp_phone_id" { type = string; default = ""; sensitive = true }
variable "whatsapp_token" { type = string; default = ""; sensitive = true }

# OpenClaw Config
variable "owner_name" { type = string; default = "" }
variable "owner_email" { type = string; default = "" }  
variable "timezone" { type = string; default = "UTC" }
variable "default_model" { type = string; default = "anthropic/claude-sonnet-4-5" }

# Skills to pre-install
variable "skills" { type = list(string); default = [] }

# Extra system packages to install (e.g. "golang", "python3-pip")
variable "extra_packages" { type = list(string); default = [] }

# Seed workspace files - map of filename to content
variable "workspace_files" { type = map(string); default = {} }

# Google/gog OAuth (for Gmail integration)
variable "google_oauth_client_id" { type = string; default = ""; sensitive = true }
variable "google_oauth_client_secret" { type = string; default = ""; sensitive = true }
variable "google_oauth_refresh_token" { type = string; default = ""; sensitive = true }
```

### 2. Updated cloud-init in ec2.tf

The user_data script should be extended to:

1. Install Node.js + OpenClaw (already done)
2. Create openclaw user (already done)
3. **NEW: If API keys are provided, write a complete openclaw.yaml config file** at `/home/openclaw/.openclaw/config.yaml`
   - Only include sections for channels/providers where tokens are actually provided
   - Use proper openclaw config format (check OpenClaw docs for yaml structure)
4. **NEW: If workspace_files are provided, write them** to `/home/openclaw/.openclaw/workspace/`
5. **NEW: If extra_packages are provided, install them** via `dnf install -y`
6. **NEW: If skills are provided, install them** via `npm exec clawhub install <skill>` as openclaw user
7. **NEW: If config was written, start the gateway** automatically instead of waiting for manual onboard
8. **NEW: Write gog OAuth tokens** to the appropriate location if provided

### 3. OpenClaw Config Format

The openclaw.yaml config should look roughly like this (only include sections where values are provided):

```yaml
version: 1

gateway:
  auth:
    token: <auto-generated UUID>
  
agents:
  default:
    model: <default_model variable>

providers:
  anthropic:
    apiKey: <anthropic_api_key>
  openai:
    apiKey: <openai_api_key>
  google:
    apiKey: <google_api_key>

channels:
  discord:
    botToken: <discord_bot_token>
    guildId: <discord_guild_id>
  telegram:
    botToken: <telegram_bot_token>
    ownerId: <telegram_owner_id>

user:
  name: <owner_name>
  email: <owner_email>
  timezone: <timezone>
```

Note: I'm not 100% sure of the exact openclaw.yaml schema. The cloud-init script should use `openclaw configure` CLI commands if available, or write the yaml directly. Check what `openclaw onboard` actually does and replicate it.

### 4. terraform.tfvars.example

Update the example file to show all the new variables with comments explaining each one.

### 5. Updated outputs.tf

Update the "next steps" output:
- If config was pre-baked, show "OpenClaw is running! Connect via SSM to check logs"
- If config was NOT provided, show the existing manual onboard instructions

### 6. Updated README.md

Add a "Pre-Configured Deployment" section showing:
- How to set variables in terraform.tfvars
- Example with Discord + Anthropic
- Example with Telegram + OpenAI
- How to add workspace seed files
- How to add skills
- Security note about using terraform.tfvars with secrets (mention .gitignore, mention AWS Secrets Manager as alternative)

### 7. .gitignore

Make sure terraform.tfvars is in .gitignore (it will contain secrets).

## Constraints
- Keep backward compatibility: if no new variables are set, behavior should be identical to the original
- All secret variables must be marked `sensitive = true`
- Don't hardcode any paths that might change between OpenClaw versions
- The cloud-init script must be idempotent (safe to re-run)
- Use `set -e` in bash scripts for safety
- Generate a random gateway auth token via `uuidgen` or `openssl rand`

## Testing
After making changes:
- `cd terraform && terraform init && terraform validate` should pass
- `terraform plan` with no variables should show same resources as before
- `terraform plan` with sample variables should show the instance being created with updated user_data

## Files to Create/Modify
- MODIFY: terraform/variables.tf
- MODIFY: terraform/ec2.tf (cloud-init user_data)
- MODIFY: terraform/outputs.tf
- MODIFY: terraform/terraform.tfvars.example
- MODIFY: README.md
- MODIFY: .gitignore
